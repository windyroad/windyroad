<?xml version="1.0" encoding="UTF-8"?>
<project name="BWUnitConfigure"
         xmlns="antlib:org.apache.tools.ant"
         xmlns:tibant="org.windyroad.tibant"
         xmlns:bwda="au.com.windyroad.bwda"
         xmlns:rsel="antlib:org.apache.tools.ant.types.resources.selectors">

	<import file="ivy-config.xml" />

	<property name="bwunit.home" location="${ivy.lib.dir.location}/BWUnit-${bwda.dep.bwunit.revision}" />
	<echo level="info">Importing ${bwunit.home}/util/bwunit.xml</echo>
	<import file="${bwunit.home}/util/bwunit.xml" />

	<target name="-load-ant-contrib" unless="ant-contrib.loaded">
		<tibant:load-ant-contrib />
		<property name="ant-contrib.loaded" value="true" />
	</target>

	<target name="-init" depends="-load-ant-contrib">
		<mkdir dir="${bwda.build.dir}" />

		<propertyset id="bwengine.properties" dynamic="true">
			<propertyset>
				<propertyref prefix="engine.properties." />
				<mapper type="glob" from="engine.properties.*" to="*" />
			</propertyset>
		</propertyset>

		<propertyset id="bwengine.gvars" dynamic="true">
			<propertyset>
				<propertyref prefix="engine.gvars." />
				<mapper type="glob" from="engine.gvars.*" to="*" />
			</propertyset>
		</propertyset>

		<for param="file">
			<fileset dir="${bwda.aliases.dir}">
				<include name="*.jar" />
				<include name="*.projlib" />
			</fileset>
			<sequential>
				<basename file="@{file}" property="engine.alias.@{file}" />
				<property name="engine.aliases.${engine.alias.@{file}}" location="@{file}" />
			</sequential>
		</for>

		<propertyset id="bwengine.aliases" dynamic="true">
			<propertyref prefix="engine.aliases." />
			<mapper type="glob" from="engine.aliases.*" to="*" />
		</propertyset>

		<pathconvert property="bwda.bwengine.classpath">
			<fileset dir="${bwda.classpath.dir}">
				<include name="*.jar" />
			</fileset>
		</pathconvert>

	</target>

	<target name="clean">
		<delete dir="${bwda.build.dir}" verbose="true" />
	</target>

	<target name="-create-ivy-file" depends="-load-ant-contrib,-get-module-org">
		<!-- create ivy file pub targets based on .archive and .libbuilder files in project -->
		<property name="ivy.dep.file" value="${bwda.build.dir}/generated-ivy.xml" />
		<echo file="${bwda.build.dir}/generated-ivy.xml">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;ivy-module version="2.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:noNamespaceSchemaLocation="http://ant.apache.org/ivy/schemas/ivy.xsd"&gt;
    &lt;info
        organisation="$${ivy.organisation}"
        module="$${ant.project.name}"
        status="release"&gt;
        &lt;extends 
            organisation="$${ivy.organisation}"
            module="$${ant.project.name}"
            revision="latest.integration"
            location="$${basedir}/ivy.xml"/&gt;
        &lt;extends 
            organisation="not.set"
            module="$${ant.project.name}"
            revision="latest.integration"
            location="$${basedir}/$${bwda.importer.dir}/ivy.xml"/&gt;
    &lt;/info&gt;
    &lt;publications&gt;
    &lt;/publications&gt;
&lt;/ivy-module&gt;</echo>

		<!-- now create an ivy file for users to enter the dependencies into -->
		<if>
			<not>
				<available file="ivy.xml" />
			</not>
			<then>
				<echo file="ivy.xml">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;ivy-module version="2.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:noNamespaceSchemaLocation="http://ant.apache.org/ivy/schemas/ivy.xsd"&gt;
    &lt;info
        organisation="$${ivy.organisation}"
        module="$${ant.project.name}"
        status="release"&gt;
    &lt;/info&gt;
    &lt;dependencies&gt;
    &lt;/dependencies&gt;
&lt;/ivy-module&gt;</echo>
			</then>
		</if>
	</target>

	<target name="-extract-config-template" depends="-retrieve-deployable">
		<mappedresources id="bwda.deployable.ears">
			<restrict>
				<fileset refid="bwda.deployable.set" />
				<rsel:name name="*.ear" />
			</restrict>
			<chainedmapper>
				<flattenmapper />
				<globmapper from="*.ear" to="*" />
			</chainedmapper>
		</mappedresources>

		<for param="ear">
			<resources refid="bwda.deployable.ears" />
			<sequential>
				<echo level="info">Extracting configuration template from '${bwda.build.dir}/deployable/@{ear}.ear'</echo>
				<property name="bwda.@{ear}.config.template" value="${bwda.build.dir}/deployable/@{ear}-template.xml" />
				<tibant:extract-config ear="${bwda.build.dir}/deployable/@{ear}.ear"
				                       out="${bwda.@{ear}.config.template}" />
			</sequential>
		</for>
	</target>

	<macrodef name="loadBinding" uri="org.windyroad.tibant">
		<attribute name="ear" />
		<attribute name="archive" />
		<attribute name="file" />
		<sequential>
			<if>
				<not>
					<isset property="bwda.deploy.@{ear}.@{archive}-bindings" />
				</not>
				<then>
					<echo level="info">Looking for '@{ear}-@{archive}' binding names in '@{file}'</echo>
					<if>
						<available file="@{file}" />
						<then>
							<!-- spaces and other characters need to be escaped when using the archive name as a property key -->
							<propertyregex property="@{archive}.escaped"
							               input="@{archive}"
							               regexp="([ =\#!:])"
							               replace="\\\\\1"
							               global="true"
							               defaultvalue="@{archive}" />

							<loadproperties srcfile="@{file}" prefix="bwda.deploy.@{ear}.">
								<filterchain>
									<striplinecomments>
										<comment value="#" />
									</striplinecomments>
									<tokenfilter>
										<ignoreblank />
									</tokenfilter>
									<expandproperties />
									<prefixlines prefix="${@{archive}.escaped}-" />
								</filterchain>
							</loadproperties>
						</then>
					</if>
				</then>
			</if>
		</sequential>
	</macrodef>

	<target name="-get-list-of-archives" depends="-extract-config-template">
		<for param="ear">
			<resources refid="bwda.deployable.ears" />
			<sequential>
				<xmlproperty file="${bwda.@{ear}.config.template}"
				             prefix="bwda.@{ear}.config.template.settings"
				             keepRoot="false" />
				<propertyset id="bwda.@{ear}.archive-list">
					<propertyref regex="^bwda\.@{ear}\.config\.template\.settings\.services\.[^\.]+\(name\)$" />
				</propertyset>
			</sequential>
		</for>
	</target>

	<target name="-load-binding-names" depends="-get-list-of-archives,-get-deployment-domain">
		<bwunit:PersitedInput property="bwda.config.deploy.dir"
		                      message="Where should BWUnit load deployment properties from, relative to `${ant.file.dir}`"
		                      defaultValue="config/deploy" />
		<mkdir dir="${bwda.config.deploy.dir}" />
		<for param="ear">
			<resources refid="bwda.deployable.ears" />
			<sequential>
				<for param="archive-list">
					<propertyset refid="bwda.@{ear}.archive-list" />
					<sequential>
						<for param="archive" list="@{archive-list}">
							<sequential>
								<!-- binding names for particular ear archive in a specific environment -->
								<tibant:loadBinding ear="@{ear}"
								                    archive="@{archive}"
								                    file="${bwda.config.deploy.dir}/${bwda.deployment.domain}-@{ear}-@{archive}-binding-names.properties" />
								<!-- binding names for particular ear archive across all environments -->
								<tibant:loadBinding ear="@{ear}"
								                    archive="@{archive}"
								                    file="${bwda.config.deploy.dir}/@{ear}-@{archive}-binding-names.properties" />
								<!-- binding names for particular archive for any ear across all environments -->
								<tibant:loadBinding ear="@{ear}"
								                    archive="@{archive}"
								                    file="${bwda.config.deploy.dir}/@{archive}-binding-names.properties" />
								<!-- binding names for particular ear in a specific environments -->
								<tibant:loadBinding ear="@{ear}"
								                    archive="@{archive}"
								                    file="${bwda.config.deploy.dir}/${bwda.deployment.domain}-@{ear}-binding-names.properties" />
								<!-- binding names for particular ear across all environments -->
								<tibant:loadBinding ear="@{ear}"
								                    archive="@{archive}"
								                    file="${bwda.config.deploy.dir}/@{ear}-binding-names.properties" />
								<!-- binding names for all ears in a specific environments -->
								<tibant:loadBinding ear="@{ear}"
								                    archive="@{archive}"
								                    file="${bwda.config.deploy.dir}/${bwda.deployment.domain}-binding-names.properties" />
								<!-- binding names for all ears across environments -->
								<tibant:loadBinding ear="@{ear}"
								                    archive="@{archive}"
								                    file="${bwda.config.deploy.dir}/binding-names.properties" />

								<!-- if the binding is not set, ask for it and store it in the most specific version of the file -->
								<if>
									<not>
										<isset property="bwda.deploy.@{ear}.@{archive}-bindings" />
									</not>
									<then>
										<input addproperty="bwda.deploy.@{ear}.@{archive}-bindings"
										       message="bwda.deploy.@{ear}.@{archive}-bindings: What are the binding names for @{ear}-@{archive}? Mutliple binding should be seperated with a comma. e.g. 'Primary,Secondary'" />
										<propertyfile file="${bwda.config.deploy.dir}/${bwda.deployment.domain}-@{ear}-@{archive}-binding-names.properties">
											<entry key="bindings" value="${bwda.deploy.@{ear}.@{archive}-bindings}" />
										</propertyfile>
										<echo level="info">bindings persisted to `${bwda.config.deploy.dir}/${bwda.deployment.domain}-@{ear}-@{archive}-binding-names.properties`</echo>
									</then>
								</if>
							</sequential>
						</for>
					</sequential>
				</for>
			</sequential>
		</for>
	</target>

	<macrodef name="loadBindingProperties" uri="org.windyroad.tibant">
		<attribute name="ear" />
		<attribute name="archive" />
		<attribute name="binding" />
		<attribute name="file" />
		<sequential>
			<echo level="info">Loading binding properties for '@{ear}-@{archive}-@{binding}' from '@{file}'</echo>
			<if>
				<available file="@{file}" />
				<then>
					<!-- spaces and other characters need to be escaped when using the archive name as a property key -->
					<propertyregex property="@{archive}-@{binding}.escaped"
					               input="@{archive}-@{binding}"
					               regexp="([ =\#!:])"
					               replace="\\\\\1"
					               global="true"
					               defaultvalue="@{archive}-@{binding}" />

					<loadproperties srcfile="@{file}" prefix="bwda.deploy.@{ear}.">
						<filterchain>
							<striplinecomments>
								<comment value="#" />
							</striplinecomments>
							<tokenfilter>
								<ignoreblank />
							</tokenfilter>
							<expandproperties />
							<prefixlines prefix="${@{archive}-@{binding}.escaped}-" />
						</filterchain>
					</loadproperties>
				</then>
			</if>
		</sequential>
	</macrodef>

	<macrodef name="PersistedBindingPropertyInput" uri="org.windyroad.tibant">
		<attribute name="property" />
		<attribute name="message" />
		<attribute name="ear" />
		<attribute name="archive" />
		<attribute name="binding" />
		<attribute name="defaultvalue" default="" />
		<sequential>
			<if>
				<not>
					<isset property="bwda.deploy.@{ear}.@{archive}-@{binding}-@{property}" />
				</not>
				<then>
					<input addproperty="bwda.deploy.@{ear}.@{archive}-@{binding}-@{property}"
					       message="bwda.deploy.@{ear}.@{archive}-@{binding}-@{property}: @{message}"
					       defaultvalue="@{defaultvalue}" />
					<propertyfile file="${bwda.config.deploy.dir}/${bwda.deployment.domain}-@{ear}-@{archive}-@{binding}-bindings.properties">
						<entry key="@{property}" value="${bwda.deploy.@{ear}.@{archive}-@{binding}-@{property}}" />
					</propertyfile>
					<echo level="info">'@{property}' persisted to `${bwda.config.deploy.dir}/${bwda.deployment.domain}-@{ear}-@{archive}-@{binding}-bindings.properties`</echo>
				</then>
			</if>
		</sequential>
	</macrodef>

	<target name="-hostname">
		<exec executable="hostname" outputproperty="hostname" />
	</target>

	<target name="-load-binding-properties" depends="-load-binding-names,-hostname">
		<for param="ear">
			<resources refid="bwda.deployable.ears" />
			<sequential>
				<for param="archive-list">
					<propertyset refid="bwda.@{ear}.archive-list" />
					<sequential>
						<for param="archive" list="@{archive-list}">
							<sequential>
								<for param="binding" list="${bwda.deploy.@{ear}.@{archive}-bindings}">
									<sequential>
										<!-- binding properties for particular ear archive binding in a specific environment -->
										<tibant:loadBindingProperties ear="@{ear}"
										                              binding="@{binding}"
										                              archive="@{archive}"
										                              file="${bwda.config.deploy.dir}/${bwda.deployment.domain}-@{ear}-@{archive}-@{binding}-bindings.properties" />
										<!-- binding properties for particular ear archive binding across all environments -->
										<tibant:loadBindingProperties ear="@{ear}"
										                              binding="@{binding}"
										                              archive="@{archive}"
										                              file="${bwda.config.deploy.dir}/@{ear}-@{archive}-@{binding}-bindings.properties" />
										<!-- binding properties for particular archive binding for any ear across all environments -->
										<tibant:loadBindingProperties ear="@{ear}"
										                              binding="@{binding}"
										                              archive="@{archive}"
										                              file="${bwda.config.deploy.dir}/@{archive}-@{binding}-bindings.properties" />
										<!-- binding properties for particular binding for any ear across all environments -->
										<tibant:loadBindingProperties ear="@{ear}"
										                              binding="@{binding}"
										                              archive="@{archive}"
										                              file="${bwda.config.deploy.dir}/@{binding}-bindings.properties" />
										<!-- binding properties for particular ear archive in a specific environment -->
										<tibant:loadBindingProperties ear="@{ear}"
										                              binding="@{binding}"
										                              archive="@{archive}"
										                              file="${bwda.config.deploy.dir}/${bwda.deployment.domain}-@{ear}-@{archive}-bindings.properties" />
										<!-- binding properties for particular ear archive across all environments -->
										<tibant:loadBindingProperties ear="@{ear}"
										                              binding="@{binding}"
										                              archive="@{archive}"
										                              file="${bwda.config.deploy.dir}/@{ear}-@{archive}-bindings.properties" />
										<!-- binding properties for particular archive for any ear across all environments -->
										<tibant:loadBindingProperties ear="@{ear}"
										                              binding="@{binding}"
										                              archive="@{archive}"
										                              file="${bwda.config.deploy.dir}/@{archive}-bindings.properties" />
										<!-- binding properties for particular ear in a specific environments -->
										<tibant:loadBindingProperties ear="@{ear}"
										                              binding="@{binding}"
										                              archive="@{archive}"
										                              file="${bwda.config.deploy.dir}/${bwda.deployment.domain}-@{ear}-bindings.properties" />
										<!-- binding properties for particular ear across all environments -->
										<tibant:loadBindingProperties ear="@{ear}"
										                              binding="@{binding}"
										                              archive="@{archive}"
										                              file="${bwda.config.deploy.dir}/@{ear}-bindings.properties" />
										<!-- binding properties for all ears in a specific environments -->
										<tibant:loadBindingProperties ear="@{ear}"
										                              binding="@{binding}"
										                              archive="@{archive}"
										                              file="${bwda.config.deploy.dir}/${bwda.deployment.domain}-bindings.properties" />
										<!-- binding properties for all ears across environments -->
										<tibant:loadBindingProperties ear="@{ear}"
										                              binding="@{binding}"
										                              archive="@{archive}"
										                              file="${bwda.config.deploy.dir}/bindings.properties" />

										<!-- if the machine property is not set, ask for it and store it in the most specific version of the file -->
										<tibant:PersistedBindingPropertyInput property="machine"
										                                      message="What machine would you like to deploy @{ear}-@{archive}-@{binding} to?"
										                                      ear="@{ear}"
										                                      binding="@{binding}"
										                                      archive="@{archive}"
										                                      defaultvalue="${hostname}" />
									</sequential>
								</for>
							</sequential>
						</for>
					</sequential>
				</for>
			</sequential>
		</for>
	</target>

	<macrodef name="loadArchiveProperties" uri="org.windyroad.tibant">
		<attribute name="ear" />
		<attribute name="archive" />
		<attribute name="file" />
		<sequential>
			<echo level="info">Loading archive properties for '@{ear}-@{archive}' from '@{file}'</echo>
			<if>
				<available file="@{file}" />
				<then>
					<!-- spaces and other characters need to be escaped when using the archive name as a property key -->
					<propertyregex property="@{archive}.escaped"
					               input="@{archive}"
					               regexp="([ =\#!:])"
					               replace="\\\\\1"
					               global="true"
					               defaultvalue="@{archive}" />

					<loadproperties srcfile="@{file}" prefix="bwda.deploy.@{ear}.">
						<filterchain>
							<striplinecomments>
								<comment value="#" />
							</striplinecomments>
							<tokenfilter>
								<ignoreblank />
							</tokenfilter>
							<expandproperties />
							<prefixlines prefix="${@{archive}.escaped}-" />
						</filterchain>
					</loadproperties>
				</then>
			</if>
		</sequential>
	</macrodef>

	<target name="-load-archive-properties" depends="-load-binding-names">
		<for param="ear">
			<resources refid="bwda.deployable.ears" />
			<sequential>
				<for param="archive-list">
					<propertyset refid="bwda.@{ear}.archive-list" />
					<sequential>
						<for param="archive" list="@{archive-list}">
							<sequential>
								<!-- archive properties for particular ear archive in a specific environment -->
								<tibant:loadArchiveProperties ear="@{ear}"
								                              archive="@{archive}"
								                              file="${bwda.config.deploy.dir}/${bwda.deployment.domain}-@{ear}-@{archive}-archive.properties" />
								<!-- archive properties for particular ear archive across all environments -->
								<tibant:loadArchiveProperties ear="@{ear}"
								                              archive="@{archive}"
								                              file="${bwda.config.deploy.dir}/@{ear}-@{archive}-archive.properties" />
								<!-- archive properties for particular archive for any ear across all environments -->
								<tibant:loadArchiveProperties ear="@{ear}"
								                              archive="@{archive}"
								                              file="${bwda.config.deploy.dir}/@{archive}-archive.properties" />
								<!-- archive properties for particular ear in a specific environments -->
								<tibant:loadArchiveProperties ear="@{ear}"
								                              archive="@{archive}"
								                              file="${bwda.config.deploy.dir}/${bwda.deployment.domain}-@{ear}-archive.properties" />
								<!-- archive properties for particular ear across all environments -->
								<tibant:loadArchiveProperties ear="@{ear}"
								                              archive="@{archive}"
								                              file="${bwda.config.deploy.dir}/@{ear}-archive.properties" />
								<!-- archive properties for all ears in a specific environments -->
								<tibant:loadArchiveProperties ear="@{ear}"
								                              archive="@{archive}"
								                              file="${bwda.config.deploy.dir}/${bwda.deployment.domain}-archive.properties" />
								<!-- archive properties for all ears across environments -->
								<tibant:loadArchiveProperties ear="@{ear}"
								                              archive="@{archive}"
								                              file="${bwda.config.deploy.dir}/archive.properties" />
							</sequential>
						</for>
					</sequential>
				</for>
			</sequential>
		</for>
	</target>

	<macrodef name="loadDeploymentProperties" uri="org.windyroad.tibant">
		<attribute name="ear" />
		<attribute name="file" />
		<sequential>
			<echo level="info">Loading deployment properties for '@{ear}' from '@{file}'</echo>
			<if>
				<available file="@{file}" />
				<then>
					<loadproperties srcfile="@{file}" prefix="bwda.deploy.@{ear}.">
						<filterchain>
							<expandproperties />
						</filterchain>
					</loadproperties>
				</then>
			</if>
		</sequential>
	</macrodef>

	<target name="-load-deployment-properties" depends="-load-binding-properties,-load-archive-properties">
		<for param="ear">
			<resources refid="bwda.deployable.ears" />
			<sequential>
				<!-- deployment properties for particular ear in a specific environment -->
				<tibant:loadDeploymentProperties ear="@{ear}"
				                                 file="${bwda.config.deploy.dir}/${bwda.deployment.domain}-@{ear}-deploy.properties" />
				<!-- deployment properties for particular ear across all environments -->
				<tibant:loadDeploymentProperties ear="@{ear}"
				                                 file="${bwda.config.deploy.dir}/@{ear}-deploy.properties" />
				<!-- deployment properties for any ear across all environments -->
				<tibant:loadDeploymentProperties ear="@{ear}" file="${bwda.config.deploy.dir}/deploy.properties" />
			</sequential>
		</for>
	</target>

	<macrodef name="loadInstanceGVarProperties" uri="org.windyroad.tibant">
		<attribute name="ear" />
		<attribute name="archive" />
		<attribute name="binding" />
		<attribute name="file" />
		<sequential>
			<echo level="info">Loading instance global variable properties for '@{ear}-@{archive}-@{binding}' from '@{file}'</echo>
			<if>
				<available file="@{file}" />
				<then>
					<!-- spaces and other characters need to be escaped when using the archive name as a property key -->
					<propertyregex property="@{archive}-@{binding}.escaped"
					               input="@{archive}-@{binding}"
					               regexp="([ =\#!:])"
					               replace="\\\\\1"
					               global="true"
					               defaultvalue="@{archive}-@{binding}" />

					<loadproperties srcfile="@{file}" prefix="bwda.gvar.@{ear}.">
						<filterchain>
							<striplinecomments>
								<comment value="#" />
							</striplinecomments>
							<tokenfilter>
								<ignoreblank />
							</tokenfilter>
							<expandproperties />
							<prefixlines prefix="${@{archive}-@{binding}.escaped}-" />
						</filterchain>
					</loadproperties>
				</then>
			</if>
		</sequential>
	</macrodef>

	<macrodef name="loadServiceGVarProperties" uri="org.windyroad.tibant">
		<attribute name="ear" />
		<attribute name="archive" />
		<attribute name="file" />
		<sequential>
			<echo level="info">Loading service global variable properties for '@{ear}-@{archive}' from '@{file}'</echo>
			<if>
				<available file="@{file}" />
				<then>
					<!-- spaces and other characters need to be escaped when using the archive name as a property key -->
					<propertyregex property="@{archive}.escaped"
					               input="@{archive}"
					               regexp="([ =\#!:])"
					               replace="\\\\\1"
					               global="true"
					               defaultvalue="@{archive}" />

					<loadproperties srcfile="@{file}" prefix="bwda.gvar.@{ear}.">
						<filterchain>
							<striplinecomments>
								<comment value="#" />
							</striplinecomments>
							<tokenfilter>
								<ignoreblank />
							</tokenfilter>
							<expandproperties />
							<prefixlines prefix="${@{archive}.escaped}-" />
						</filterchain>
					</loadproperties>
				</then>
			</if>
		</sequential>
	</macrodef>

	<macrodef name="loadGVarProperties" uri="org.windyroad.tibant">
		<attribute name="ear" />
		<attribute name="file" />
		<sequential>
			<echo level="info">Loading global variable properties for '@{ear}' from '@{file}'</echo>
			<if>
				<available file="@{file}" />
				<then>
					<loadproperties srcfile="@{file}" prefix="bwda.gvar.@{ear}.">
						<filterchain>
							<expandproperties />
						</filterchain>
					</loadproperties>
				</then>
			</if>
		</sequential>
	</macrodef>



	<target name="-load-global-variables" depends="-load-binding-names,-get-gvar-config-dir">
		<mkdir dir="${bwda.config.gvar.dir}" />
		<for param="ear">
			<resources refid="bwda.deployable.ears" />
			<sequential>
				<for param="archive-list">
					<propertyset refid="bwda.@{ear}.archive-list" />
					<sequential>
						<for param="archive" list="@{archive-list}">
							<sequential>
								<for param="binding" list="${bwda.deploy.@{ear}.@{archive}-bindings}">
									<sequential>
										<!-- gvar properties for particular ear archive binding in a specific environment -->
										<tibant:loadInstanceGVarProperties ear="@{ear}"
										                                   binding="@{binding}"
										                                   archive="@{archive}"
										                                   file="${bwda.config.gvar.dir}/${bwda.deployment.domain}-@{ear}-@{archive}-@{binding}-gvar.properties" />
										<!-- gvar properties for particular ear archive binding across all environments -->
										<tibant:loadInstanceGVarProperties ear="@{ear}"
										                                   binding="@{binding}"
										                                   archive="@{archive}"
										                                   file="${bwda.config.gvar.dir}/@{ear}-@{archive}-@{binding}-gvar.properties" />
										<!-- gvar properties for particular archive binding for any ear across all environments -->
										<tibant:loadInstanceGVarProperties ear="@{ear}"
										                                   binding="@{binding}"
										                                   archive="@{archive}"
										                                   file="${bwda.config.gvar.dir}/@{archive}-@{binding}-gvar.properties" />
										<!-- gvar properties for particular binding for any ear across all environments -->
										<tibant:loadInstanceGVarProperties ear="@{ear}"
										                                   binding="@{binding}"
										                                   archive="@{archive}"
										                                   file="${bwda.config.gvar.dir}/@{binding}-gvar.properties" />
										<!-- gvar properties for particular ear archive in a specific environment -->
										<tibant:loadInstanceGVarProperties ear="@{ear}"
										                                   binding="@{binding}"
										                                   archive="@{archive}"
										                                   file="${bwda.config.gvar.dir}/${bwda.deployment.domain}-@{ear}-@{archive}-gvar.properties" />
										<!-- gvar properties for particular ear archive across all environments -->
										<tibant:loadInstanceGVarProperties ear="@{ear}"
										                                   binding="@{binding}"
										                                   archive="@{archive}"
										                                   file="${bwda.config.gvar.dir}/@{ear}-@{archive}-gvar.properties" />
										<!-- gvar properties for particular archive for any ear across all environments -->
										<tibant:loadInstanceGVarProperties ear="@{ear}"
										                                   binding="@{binding}"
										                                   archive="@{archive}"
										                                   file="${bwda.config.gvar.dir}/@{archive}-gvar.properties" />
										<!-- gvar properties for particular ear in a specific environments -->
										<tibant:loadInstanceGVarProperties ear="@{ear}"
										                                   binding="@{binding}"
										                                   archive="@{archive}"
										                                   file="${bwda.config.gvar.dir}/${bwda.deployment.domain}-@{ear}-gvar.properties" />
										<!-- gvar properties for particular ear across all environments -->
										<tibant:loadInstanceGVarProperties ear="@{ear}"
										                                   binding="@{binding}"
										                                   archive="@{archive}"
										                                   file="${bwda.config.gvar.dir}/@{ear}-gvar.properties" />
										<!-- gvar properties for all ears in a specific environments -->
										<tibant:loadInstanceGVarProperties ear="@{ear}"
										                                   binding="@{binding}"
										                                   archive="@{archive}"
										                                   file="${bwda.config.gvar.dir}/${bwda.deployment.domain}-gvar.properties" />
										<!-- gvar properties for all ears across environments -->
										<tibant:loadInstanceGVarProperties ear="@{ear}"
										                                   binding="@{binding}"
										                                   archive="@{archive}"
										                                   file="${bwda.config.gvar.dir}/gvar.properties" />
									</sequential>
								</for>
								<!-- gvar properties for particular ear archive in a specific environment -->
								<tibant:loadServiceGVarProperties ear="@{ear}"
								                                  archive="@{archive}"
								                                  file="${bwda.config.gvar.dir}/${bwda.deployment.domain}-@{ear}-@{archive}-gvar.properties" />
								<!-- gvar properties for particular ear archive across all environments -->
								<tibant:loadServiceGVarProperties ear="@{ear}"
								                                  archive="@{archive}"
								                                  file="${bwda.config.gvar.dir}/@{ear}-@{archive}-gvar.properties" />
								<!-- gvar properties for particular archive for any ear across all environments -->
								<tibant:loadServiceGVarProperties ear="@{ear}"
								                                  archive="@{archive}"
								                                  file="${bwda.config.gvar.dir}/@{archive}-gvar.properties" />
								<!-- gvar properties for particular ear in a specific environments -->
								<tibant:loadServiceGVarProperties ear="@{ear}"
								                                  archive="@{archive}"
								                                  file="${bwda.config.gvar.dir}/${bwda.deployment.domain}-@{ear}-gvar.properties" />
								<!-- gvar properties for particular ear across all environments -->
								<tibant:loadServiceGVarProperties ear="@{ear}"
								                                  archive="@{archive}"
								                                  file="${bwda.config.gvar.dir}/@{ear}-gvar.properties" />
								<!-- gvar properties for all ears in a specific environments -->
								<tibant:loadServiceGVarProperties ear="@{ear}"
								                                  archive="@{archive}"
								                                  file="${bwda.config.gvar.dir}/${bwda.deployment.domain}-gvar.properties" />
								<!-- gvar properties for all ears across environments -->
								<tibant:loadServiceGVarProperties ear="@{ear}"
								                                  archive="@{archive}"
								                                  file="${bwda.config.gvar.dir}/gvar.properties" />

							</sequential>
						</for>
					</sequential>
				</for>
				<!-- gvar properties for particular ear in a specific environments -->
				<tibant:loadGVarProperties ear="@{ear}"
				                           file="${bwda.config.gvar.dir}/${bwda.deployment.domain}-@{ear}-gvar.properties" />
				<!-- gvar properties for particular ear across all environments -->
				<tibant:loadGVarProperties ear="@{ear}" file="${bwda.config.gvar.dir}/@{ear}-gvar.properties" />
				<!-- gvar properties for all ears in a specific environments -->
				<tibant:loadGVarProperties ear="@{ear}"
				                           file="${bwda.config.gvar.dir}/${bwda.deployment.domain}-gvar.properties" />
				<!-- gvar properties for all ears across environments -->
				<tibant:loadGVarProperties ear="@{ear}" file="${bwda.config.gvar.dir}/gvar.properties" />
			</sequential>
		</for>
	</target>


	<macrodef name="loadServiceSDKProperties" uri="org.windyroad.tibant">
		<attribute name="ear" />
		<attribute name="archive" />
		<attribute name="file" />
		<sequential>
			<echo level="info">Loading service Adapter SDK properties for '@{ear}-@{archive}' from '@{file}'</echo>
			<if>
				<available file="@{file}" />
				<then>
					<!-- spaces and other characters need to be escaped when using the archive name as a property key -->
					<propertyregex property="@{archive}.escaped"
					               input="@{archive}"
					               regexp="([ =\#!:])"
					               replace="\\\\\1"
					               global="true"
					               defaultvalue="@{archive}" />

					<loadproperties srcfile="@{file}" prefix="bwda.sdk.@{ear}.">
						<filterchain>
							<striplinecomments>
								<comment value="#" />
							</striplinecomments>
							<tokenfilter>
								<ignoreblank />
							</tokenfilter>
							<expandproperties />
							<prefixlines prefix="${@{archive}.escaped}-" />
						</filterchain>
					</loadproperties>
				</then>
			</if>
		</sequential>
	</macrodef>

	<macrodef name="loadSDKProperties" uri="org.windyroad.tibant">
		<attribute name="ear" />
		<attribute name="file" />
		<sequential>
			<echo level="info">Loading Adapter SDK properties for '@{ear}' from '@{file}'</echo>
			<if>
				<available file="@{file}" />
				<then>
					<loadproperties srcfile="@{file}" prefix="bwda.sdk.@{ear}.">
						<filterchain>
							<expandproperties />
						</filterchain>
					</loadproperties>
				</then>
			</if>
		</sequential>
	</macrodef>

	<target name="-load-sdk-properties" depends="-load-binding-names,-get-sdk-config-dir">
		<mkdir dir="${bwda.config.sdk.dir}" />
		<for param="ear">
			<resources refid="bwda.deployable.ears" />
			<sequential>
				<for param="archive-list">
					<propertyset refid="bwda.@{ear}.archive-list" />
					<sequential>
						<for param="archive" list="@{archive-list}">
							<sequential>
								<!-- gvar properties for particular ear archive in a specific environment -->
								<tibant:loadServiceSDKProperties ear="@{ear}"
								                                 archive="@{archive}"
								                                 file="${bwda.config.sdk.dir}/${bwda.deployment.domain}-@{ear}-@{archive}-sdk.properties" />
								<!-- gvar properties for particular ear archive across all environments -->
								<tibant:loadServiceSDKProperties ear="@{ear}"
								                                 archive="@{archive}"
								                                 file="${bwda.config.sdk.dir}/@{ear}-@{archive}-sdk.properties" />
								<!-- gvar properties for particular archive for any ear across all environments -->
								<tibant:loadServiceSDKProperties ear="@{ear}"
								                                 archive="@{archive}"
								                                 file="${bwda.config.sdk.dir}/@{archive}-sdk.properties" />
								<!-- gvar properties for particular ear in a specific environments -->
								<tibant:loadServiceSDKProperties ear="@{ear}"
								                                 archive="@{archive}"
								                                 file="${bwda.config.sdk.dir}/${bwda.deployment.domain}-@{ear}-sdk.properties" />
								<!-- gvar properties for particular ear across all environments -->
								<tibant:loadServiceSDKProperties ear="@{ear}"
								                                 archive="@{archive}"
								                                 file="${bwda.config.sdk.dir}/@{ear}-sdk.properties" />
								<!-- gvar properties for all ears in a specific environments -->
								<tibant:loadServiceSDKProperties ear="@{ear}"
								                                 archive="@{archive}"
								                                 file="${bwda.config.sdk.dir}/${bwda.deployment.domain}-sdk.properties" />
								<!-- gvar properties for all ears across environments -->
								<tibant:loadServiceSDKProperties ear="@{ear}"
								                                 archive="@{archive}"
								                                 file="${bwda.config.sdk.dir}/sdk.properties" />

							</sequential>
						</for>
					</sequential>
				</for>
				<!-- gvar properties for particular ear in a specific environments -->
				<tibant:loadSDKProperties ear="@{ear}"
				                          file="${bwda.config.sdk.dir}/${bwda.deployment.domain}-@{ear}-sdk.properties" />
				<!-- gvar properties for particular ear across all environments -->
				<tibant:loadSDKProperties ear="@{ear}" file="${bwda.config.sdk.dir}/@{ear}-sdk.properties" />
				<!-- gvar properties for all ears in a specific environments -->
				<tibant:loadSDKProperties ear="@{ear}"
				                          file="${bwda.config.sdk.dir}/${bwda.deployment.domain}-sdk.properties" />
				<!-- gvar properties for all ears across environments -->
				<tibant:loadSDKProperties ear="@{ear}" file="${bwda.config.sdk.dir}/sdk.properties" />
			</sequential>
		</for>
	</target>

	<target name="-load-config" depends="-determine-config-version,-load-deployment-properties,-load-global-variables,-load-sdk-properties" />

	<target name="configure-ear"
	        depends="-load-config"
	        description="Configure the EAR files for a specific environment">
		<for param="ear">
			<resources refid="bwda.deployable.ears" />
			<sequential>
				<propertyset id="bwda.config.@{ear}.gvar">
					<propertyref prefix="bwda.gvar.@{ear}." />
					<globmapper from='bwda.gvar.@{ear}.*' to='*' />
				</propertyset>
				<propertyset id="bwda.config.@{ear}.sdk">
					<propertyref prefix="bwda.sdk.@{ear}." />
					<globmapper from='bwda.sdk.@{ear}.*' to='*' />
				</propertyset>
				<propertyset id="bwda.config.@{ear}.deploy">
					<propertyref prefix="bwda.deploy.@{ear}." />
					<globmapper from='bwda.deploy.@{ear}.*' to='*' />
				</propertyset>
				<bwda:PersitedInputVA property="bwda.config.fail.on.unset.global.variables.@{ear}"
				                      message="The build should fail if there are global variables in '@{ear}' that have not been set."
				                      validargs="true,false"
				                      defaultValue="false" />
				<bwda:PersitedInputVA property="bwda.config.fail.on.unknown.sdk.properties.@{ear}"
				                      message="The build should fail if Adapter SDK properties missing from '@{ear}' have not been set."
				                      validargs="true,false"
				                      defaultValue="false" />
				<echo level="info">Creating configuration from template '${bwda.@{ear}.config.template}'</echo>
				<property name="bwda.@{ear}.config" value="${bwda.build.dir}/deployable/@{ear}.xml" />
				<tibant:configure-ear xml="${bwda.@{ear}.config.template}"
				                      out="${bwda.@{ear}.config}"
				                      global-variables-refid="bwda.config.@{ear}.gvar"
				                      adapter-sdk-properties-refid="bwda.config.@{ear}.sdk"
				                      deployment-properties-refid="bwda.config.@{ear}.deploy"
				                      fail-on-unset-global-variables="${bwda.config.fail.on.unset.global.variables.@{ear}}"
				                      fail-on-unknown-adapter-sdk-properties="${bwda.config.fail.on.unknown.sdk.properties.@{ear}}"
				                      working-dir="${bwda.build.dir}/working" />
			</sequential>
		</for>
	</target>




</project>
